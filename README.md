# GAN-Based Calibration for Traffic Microsimulation

This project develops a novel GAN-based calibration framework to generate realistic traffic patterns in microsimulation tools like SUMO. Instead of relying on traditional error metrics and optimization heuristics, this approach uses adversarial learning to align simulation outputs with real-world traffic dynamics.

## Project Purpose
The core objective is to use a Generative Adversarial Network (GAN) to calibrate traffic microsimulations such that their output closely replicates observed traffic patterns. This includes complex emergent behaviors such as congestion bottlenecks, stop-and-go waves, queue formations, and shockwave propagation.

## What Defines Realism?
Realism in this context means how well the simulation reproduces spatial-temporal traffic behaviors observed in the real world. Specific patterns include:
•	Congestion bottlenecks
•	Stop-and-go traffic waves
•	Queue lengths and persistence
•	Shockwave speeds and propagation


## GAN Architecture

The project uses a Generative Adversarial Network (GAN) to calibrate traffic microsimulations. The GAN consists of two main components: a discriminator and a generator.

*   **Discriminator:** A neural network trained to distinguish between real and simulated traffic patterns. It is trained on two data sources:
    *   Real data: Detector data from real-world traffic.
    *   Fake data: Synthetic traffic patterns generated by the SUMO traffic simulator.

    The discriminator outputs a "realism score" to evaluate the plausibility of simulation outputs. The discriminator takes as input both traffic patterns (flow, density, speed) and OD matrices.

*   **Generator:** The SUMO traffic simulator acts as the generator in the GAN architecture. It produces traffic patterns based on input parameters including demand profiles and driver behavior settings.

*   **Output:** The trained GAN framework identifies the set of SUMO inputs (demand and behavior parameters) that generate the most realistic traffic patterns.

## Training Process

The training process involves the following steps:

1.  **Data Generation:** Generate real and synthetic traffic data using the SUMO traffic simulator. The synthetic data is generated by varying the driver behavior parameters.
2.  **Discriminator Training:** Train the discriminator to distinguish between real and synthetic traffic data. The discriminator is trained using a binary cross-entropy loss function.
3.  **Calibration Process:** Use the trained discriminator to guide the calibration of the SUMO traffic simulator. The calibration process involves optimizing the driver behavior parameters to minimize the adversarial loss, which is the negative logarithm of the realism score. The optimization is performed using Optuna, a hyperparameter optimization framework.

## Calibration Process

The calibration process uses the trained discriminator to guide the optimization of the SUMO simulation parameters. The objective function is defined as the adversarial loss, which is the negative logarithm of the realism score. The optimization is performed using Optuna, a hyperparameter optimization framework. The parameters being optimized include driver behavior parameters such as maximum speed, minimum gap, acceleration, and deceleration.

## Repository Structure

The repository is organized as follows:

*   **`data/`:** Contains real-world traffic data and synthetic data generated by the GAN.
*   **`sumo/`:** Contains SUMO traffic simulation files, including network definitions, route definitions, and simulation configurations.
    *   **`SCENARIO/`:** Contains files specific to the `SCENARIO` traffic scenario (e.g., `on_ramp`, `I24`).
        *   `SCENARIO_pretrain_cGAN.py`: Script for pre-training the GAN discriminator.
        *   `SCENARIO_cGAN.py`: Script for calibrating the SUMO simulation using the trained GAN.
        *   `*.net.xml`, `*.rou.xml`, `*.sumocfg`, `.add.xml`: SUMO configuration files.
*   **`utils_data_read.py`:** Utility functions for reading and processing traffic data.
*   **`utils_macro.py`:** Utility functions for computing macroscopic traffic quantities.
*   **`utils_vis.py`:** Utility functions for visualizing traffic data and simulation results.

## How to Use

### Setting up the environment

1.  Install the required dependencies: `pip install -r requirements.txt` (Note: `requirements.txt` is not listed in the file list, but it's good practice to include this step).
2.  Download the I-24 MOTION data from the [I-24 MOTION project website](https://i24motion.org) and place it in the `data/` directory.
3.  Install SUMO traffic simulator.

### Running a basic simulation

1.  Navigate to the `sumo/SCENARIO/` directory: `cd sumo/SCENARIO/` (replace `SCENARIO` with the actual scenario name).
2.  Run the SUMO simulation: `sumo -c SCENARIO.sumocfg` (replace `SCENARIO` with the actual scenario name).

### Training or loading a pretrained GAN discriminator

1.  Navigate to the `sumo/SCENARIO/` directory: `cd sumo/SCENARIO/` (replace `SCENARIO` with the actual scenario name).
2.  To train the discriminator, run: `python SCENARIO_pretrain_cGAN.py` (replace `SCENARIO` with the actual scenario name).
3.  To load a pretrained discriminator, modify the `SCENARIO_calibrate.py` script to load the weights from the `discriminator.pth` file (replace `SCENARIO` with the actual scenario name).

### Calibrating a new corridor or scenario

1.  Create a new directory under `sumo/` for your corridor or scenario.
2.  Create the necessary SUMO configuration files (`.net.xml`, `.rou.xml`, `.sumocfg`, `.add.xml`).
3.  Modify the `SCENARIO_calibrate.py` script to use your scenario's configuration files and data (replace `SCENARIO` with the actual scenario name).
4.  Run the calibration script: `python SCENARIO_calibrate.py` (replace `SCENARIO` with the actual scenario name).

## Expected Outputs

*   **Calibrated simulation traces:** SUMO simulation output files (`.xml`) containing the calibrated traffic data.
*   **Pretrained discriminator weights:** PyTorch model weights (`discriminator.pth`) for the trained GAN discriminator.
*   **Scenario libraries:** Collections of SUMO scenarios for AV testing and safety evaluation.

## Who Is This For

This project is intended for transportation researchers, simulation engineers, and AV developers who are interested in using GANs to improve the realism and generalizability of traffic microsimulations.

## Future Work

*   **cGAN-based rare event synthesis:** Use cGANs to generate rare but critical traffic events for safety evaluation.
*   **Integration with conditional inputs:** Incorporate conditional inputs such as weather or demand levels into the GAN to generate more realistic and context-aware traffic scenarios.
